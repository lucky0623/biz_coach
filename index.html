<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- iPad æœ€ä½³åŒ– viewport è¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Lightning Coach Lite</title>
  
  <!-- iOS/iPadOS PWA è¨­å®š -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Lightning Coach" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0b0b0e" />
  <meta name="format-detection" content="telephone=no" />
  
  <!-- iOS è§¸æ§åœ–æ¨™ -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230b0b0e' width='180' height='180' rx='40'/><text x='90' y='125' font-size='100' text-anchor='middle'>âš¡</text></svg>" />
  
  <!-- PWA Manifest (å…§åµŒ) -->
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Lightning%20Coach%22%2C%22short_name%22%3A%22Coach%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230b0b0e%22%2C%22theme_color%22%3A%22%230b0b0e%22%7D" />
  
  <style>
    :root{
      --bg:#0b0b0e;
      --card:#14141b;
      --muted:#a9a9b5;
      --text:#f3f3f6;
      --line:#2a2a34;A
      --ok:#3ddc97;
      --warn:#ffd166;
      --bad:#ff5c7a;
      --accent:#6ea8fe;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --tap:68px;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, "Segoe UI", Roboto, "Noto Sans", "PingFang TC", "Heiti TC", sans-serif;
      
      /* iOS Safe Area Insets */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }
    
    *{
      box-sizing:border-box;
      /* é˜²æ­¢ iOS é•·æŒ‰é¸å– */
      -webkit-touch-callout: none;
    }
    
    html{
      /* é˜²æ­¢ iOS å½ˆæ€§æ»¾å‹•æº¢å‡º */
      height: 100%;
      overflow: hidden;
    }
    
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 10% 0%, rgba(110,168,254,.14), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(61,220,151,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      /* iOS æ»¾å‹•æœ€ä½³åŒ– */
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      /* é˜²æ­¢ä¸‹æ‹‰åˆ·æ–° */
      overscroll-behavior-y: none;
      /* é˜²æ­¢æ–‡å­—é¸å– */
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* å…è¨±è¼¸å…¥æ¡†é¸å–æ–‡å­— */
    textarea, input {
      -webkit-user-select: text;
      user-select: text;
    }
    
    .top{
      position:sticky; 
      top:0; 
      z-index:20;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(11,11,14,.78);
      border-bottom:1px solid rgba(42,42,52,.85);
      /* Safe Area é ‚éƒ¨é‚Šè· */
      padding-top: var(--safe-top);
    }
    
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding: 14px;
      padding-left: max(14px, var(--safe-left));
      padding-right: max(14px, var(--safe-right));
      padding-bottom: 18px;
    }
    
    .wrap.main{
      /* åº•éƒ¨ Safe Area */
      padding-bottom: calc(18px + var(--safe-bottom));
    }
    
    .bar{display:flex;align-items:center;gap:10px}
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);line-height:1.35;margin-top:2px}
    .spacer{flex:1}

    .pill{
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.65);
      padding:8px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .icon{
      /* iPad å¤§è§¸æ§ç›®æ¨™ - è‡³å°‘ 44pt */
      width:56px;
      height:56px;
      border-radius:16px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.70);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
      cursor:pointer;
      -webkit-user-select:none;
      user-select:none;
      /* é˜²æ­¢é›™æ“Šç¸®æ”¾ */
      touch-action: manipulation;
      /* iOS è§¸æ§å›é¥‹ */
      -webkit-tap-highlight-color: rgba(110,168,254,0.2);
      transition: transform 0.1s ease, background 0.15s ease;
    }
    .icon:active{
      transform: scale(0.95);
      background: rgba(30,30,40,.90);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid rgba(42,42,52,.92);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      margin-top:14px;
    }

    textarea{
      width:100%;
      min-height:140px;
      resize:none; /* iPad ä¸Šç¦ç”¨æ‹–å‹•èª¿æ•´å¤§å° */
      border-radius:16px;
      padding:16px;
      background: rgba(20,20,27,.78);
      border:1px solid rgba(42,42,52,.95);
      color:var(--text);
      /* è¼ƒå¤§å­—é«”é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
      font-size:18px;
      line-height:1.4;
      outline:none;
      /* iOS è¼¸å…¥æ¡†æ¨£å¼ä¿®æ­£ */
      -webkit-appearance: none;
      appearance: none;
      /* é˜²æ­¢éµç›¤å½ˆå‡ºæ™‚é é¢ç¸®æ”¾ */
      transform: translateZ(0);
    }
    textarea:focus{
      border-color: rgba(110,168,254,.8); 
      box-shadow: 0 0 0 4px rgba(110,168,254,.15);
    }
    textarea::placeholder{
      color: var(--muted);
      opacity: 0.7;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .btn{
      /* iPad å¤§æŒ‰éˆ• - ç¬¦åˆ Apple HIG 44pt æœ€å°è§¸æ§ç›®æ¨™ */
      height:var(--tap);
      min-height: 52px;
      border-radius:18px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.78);
      color:var(--text);
      padding:0 20px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      -webkit-user-select:none;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(110,168,254,0.2);
      display:flex;align-items:center;justify-content:center;gap:10px;
      flex:1;
      min-width:140px;
      /* iOS æŒ‰éˆ•æ¨£å¼ä¿®æ­£ */
      -webkit-appearance: none;
      appearance: none;
      /* æµæš¢éæ¸¡å‹•ç•« */
      transition: transform 0.1s ease, opacity 0.15s ease, background 0.15s ease;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(110,168,254,.28), rgba(110,168,254,.14)); 
      border-color: rgba(110,168,254,.75);
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,92,122,.25), rgba(255,92,122,.10)); 
      border-color: rgba(255,92,122,.75);
    }
    .btn:active{
      transform: scale(0.97);
      opacity: 0.9;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .mini{
      height:56px;
      min-height:56px;
      border-radius:16px;
      font-size:15px;
      font-weight:600;
      padding:0 16px;
      flex:0 0 auto;
      min-width:auto;
    }

    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      /* è¼ƒå¤§çš„ chip è§¸æ§ç›®æ¨™ */
      padding:14px 18px;
      border-radius:999px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.62);
      color:var(--text);
      font-size:15px;
      cursor:pointer;
      -webkit-user-select:none;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(61,220,151,0.2);
      transition: transform 0.1s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .chip:active{
      transform: scale(0.96);
    }
    .chip.on{
      border-color: rgba(61,220,151,.85); 
      box-shadow: 0 0 0 3px rgba(61,220,151,.14) inset;
    }

    .tabs{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .tab{
      flex:1;
      min-width:100px;
      height:60px;
      border-radius:16px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.60);
      color:var(--muted);
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      -webkit-user-select:none;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(110,168,254,0.2);
      display:flex;align-items:center;justify-content:center;gap:8px;
      -webkit-appearance: none;
      appearance: none;
      transition: transform 0.1s ease, color 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }
    .tab:active{
      transform: scale(0.97);
    }
    .tab.on{
      color:var(--text); 
      border-color: rgba(110,168,254,.65); 
      background: rgba(110,168,254,.10);
    }

    .out{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.58);
      padding:16px;
      /* é•·å…§å®¹å¯æ»¾å‹• */
      max-height: 280px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .out pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:20px;
      line-height:1.4;
      min-height:100px;
      font-family: var(--font);
      /* å…è¨±é¸å–è¼¸å‡ºæ–‡å­— */
      -webkit-user-select: text;
      user-select: text;
    }

    details{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(20,20,27,.55);
      padding:14px 16px;
    }
    summary{
      cursor:pointer; 
      font-weight:700; 
      color:var(--muted); 
      font-size:15px;
      /* è¼ƒå¤§çš„è§¸æ§ç›®æ¨™ */
      padding: 4px 0;
      touch-action: manipulation;
    }
    details .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .modalOverlay{
      position:fixed; 
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      z-index:40;
    }
    .modal{
      position:fixed;
      left:50%; 
      top:50%; 
      transform: translate(-50%,-50%);
      width:min(720px, calc(100vw - 32px));
      max-height: calc(100vh - 80px - var(--safe-top) - var(--safe-bottom));
      background: rgba(20,20,27,.96);
      border:1px solid rgba(42,42,52,.95);
      border-radius:22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding:16px;
      display:none;
      z-index:41;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal h2{margin:0 0 12px 0;font-size:18px}
    .grid2{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }
    
    .field label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 8px;
    }
    input[type="text"], input[type="password"], select{
      width:100%;
      height:56px;
      border-radius:16px;
      padding:0 14px;
      border:1px solid rgba(42,42,52,.95);
      background: rgba(11,11,14,.65);
      color:var(--text);
      /* è¼ƒå¤§å­—é«”é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
      font-size:16px;
      outline:none;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus, select:focus{
      border-color: rgba(110,168,254,.8); 
      box-shadow: 0 0 0 4px rgba(110,168,254,.15);
    }
    
    /* iOS select ä¸‹æ‹‰ç®­é ­ */
    select{
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a9a9b5' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
      color:var(--muted);
      font-size:14px;
    }
    .toggle input[type="checkbox"]{
      width:52px;
      height:32px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(42,42,52,.8);
      border-radius:16px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .toggle input[type="checkbox"]::before{
      content: '';
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--text);
      top: 3px;
      left: 3px;
      transition: transform 0.2s ease;
    }
    .toggle input[type="checkbox"]:checked{
      background: var(--ok);
    }
    .toggle input[type="checkbox"]:checked::before{
      transform: translateX(20px);
    }

    .foot{
      margin-top:14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .smallText{
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    
    /* iPad æ©«å‘ç‰¹æ®Šæœ€ä½³åŒ– */
    @media (min-width: 768px) and (orientation: landscape) {
      .wrap{
        max-width: 1000px;
        padding: 16px 24px;
      }
      .card{
        padding: 18px;
      }
      textarea{
        min-height: 120px;
      }
      .out{
        max-height: 200px;
      }
      .tabs{
        gap: 12px;
      }
      .tab{
        height: 56px;
        font-size: 14px;
      }
    }
    
    /* iPad Pro 12.9" å¤§è¢å¹•æœ€ä½³åŒ– */
    @media (min-width: 1024px) {
      :root{
        --tap: 72px;
      }
      h1{
        font-size: 20px;
      }
      .out pre{
        font-size: 22px;
      }
    }
    
    /* æ·±è‰²æ¨¡å¼å¼·åˆ¶ï¼ˆiPad å·²æ˜¯æ·±è‰²ä¸»é¡Œï¼‰ */
    @media (prefers-color-scheme: dark) {
      /* å·²ç¶“æ˜¯æ·±è‰²ä¸»é¡Œï¼Œç„¡éœ€è®Šæ›´ */
    }
    
    /* æ¸›å°‘å‹•ç•«ï¼ˆç„¡éšœç¤™è¨­å®šï¼‰ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        transition-duration: 0.01ms !important;
        animation-duration: 0.01ms !important;
      }
    }
    
    /* éµç›¤å½ˆå‡ºæ™‚çš„è™•ç† */
    @supports (-webkit-touch-callout: none) {
      /* iOS Safari ç‰¹æœ‰ä¿®æ­£ */
      body.keyboard-open .wrap.main{
        padding-bottom: 0;
      }
    }
    
    /* è§¸æ§æŒ‰å£“è¦–è¦ºå›é¥‹ */
    @media (hover: none) and (pointer: coarse) {
      .btn:hover,
      .chip:hover,
      .tab:hover,
      .icon:hover {
        /* ç§»é™¤ hover ç‹€æ…‹ï¼Œåƒ…ä¿ç•™ active */
        background: inherit;
      }
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="bar">
        <div>
          <h1>âš¡ Lightning Coach Lite</h1>
          <div class="sub">Big buttons Â· Big text Â· Instant draft â†’ live upgrade</div>
        </div>
        <div class="spacer"></div>
        <div class="pill" id="statusPill"><span class="dot warn" id="dot"></span><span id="status">Ready</span></div>
        <div class="icon" id="gear" title="Settings" role="button" aria-label="Settings">âš™ï¸</div>
      </div>
    </div>
  </div>

  <div class="wrap main">
    <div class="card">
      <textarea 
        id="q" 
        placeholder='Type keywords fast. Example: "raise prices during inflation? risks? communication?"'
        enterkeyhint="send"
        autocomplete="off"
        autocorrect="on"
        autocapitalize="sentences"
        spellcheck="true"
      ></textarea>

      <div class="chips" id="chips">
        <div class="chip" data-chip="Use a concrete example." role="button" tabindex="0">ğŸ“Œ Example</div>
        <div class="chip" data-chip="Mention a trade-off (pros/cons)." role="button" tabindex="0">âš–ï¸ Trade-off</div>
        <div class="chip" data-chip="Add a risk + mitigation." role="button" tabindex="0">ğŸ›¡ï¸ Risk/Mitigation</div>
      </div>

      <div class="row" style="margin-top:14px">
        <button class="btn secondary" id="quick" type="button">âš¡ Quick</button>
        <button class="btn primary" id="polish" type="button">âœ¨ Polished</button>
        <button class="btn danger" id="stop" disabled style="flex:0 0 auto; min-width:140px" type="button">â›” Stop</button>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn mini" id="paste" type="button">ğŸ“¥ Paste</button>
        <button class="btn mini" id="example" type="button">ğŸ§ª Example</button>
        <button class="btn mini" id="copy" type="button">ğŸ“‹ Copy</button>
        <button class="btn mini" id="speak" type="button">ğŸ”Š Speak</button>
      </div>

      <div class="tabs" style="margin-top:14px" role="tablist">
        <button class="tab on" data-tab="safe" role="tab" aria-selected="true" type="button">âœ… SAFE</button>
        <button class="tab" data-tab="strong" role="tab" aria-selected="false" type="button">ğŸ”¥ STRONG</button>
        <button class="tab" data-tab="question" role="tab" aria-selected="false" type="button">â“ QUESTION</button>
      </div>

      <div class="out" role="tabpanel">
        <pre id="out">â€”</pre>
      </div>

      <details>
        <summary>ğŸ“ Notes (optional)</summary>
        <div style="margin-top:10px">
          <pre id="notes" style="white-space:pre-wrap; word-break:break-word; font-size:15px; color:var(--muted); margin:0; -webkit-user-select:text; user-select:text;">â€”</pre>
        </div>
        <div class="hint">Notes are for your own study. Keep it ethical: this app helps you express your thinking, not replace it.</div>
      </details>

      <div class="smallText" style="margin-top:12px">
        Shortcuts: <b>Enter</b> Quick Â· <b>âŒ˜+Enter</b> Polished Â· <b>Esc</b> Stop
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalOverlay" id="overlay"></div>
  <div class="modal" id="modal" role="dialog" aria-labelledby="modalTitle">
    <h2 id="modalTitle">Settings</h2>
    <div class="grid2">
      <div class="field">
        <label for="provider">Provider</label>
        <select id="provider">
          <option value="openai">OpenAI (Chat Completions)</option>
          <option value="template">Template-only (instant)</option>
        </select>
      </div>
      <div class="field">
        <label for="model">Model (for Polished)</label>
        <select id="model">
          <option value="gpt-5.2">gpt-5.2 (æœ€å¼·ï¼Œæ¨ç†)</option>
          <option value="gpt-5.2-chat-latest">gpt-5.2-chat-latest (å¿«é€Ÿ)</option>
          <option value="gpt-4o">gpt-4o (æ¨è–¦ï¼Œç©©å®š)</option>
          <option value="gpt-4o-mini">gpt-4o-mini (ä¾¿å®œå¿«é€Ÿ)</option>
          <option value="gpt-4.1">gpt-4.1</option>
          <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="key">OpenAI API Key</label>
      <input id="key" type="password" placeholder="sk-..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      <div class="toggle">
        <input type="checkbox" id="remember" />
        <label for="remember">Remember on this device</label>
      </div>
    </div>

    <div class="field">
      <label for="endpoint">Endpoint / Proxy URL</label>
      <input id="endpoint" type="text" value="https://api.openai.com/v1/chat/completions" autocomplete="off" autocorrect="off" autocapitalize="off" />
      <div class="smallText" style="margin-top:8px">Default: OpenAI Chat Completions API. Change if using a proxy.</div>
    </div>

    <div class="foot">
      <button class="btn mini primary" id="close" type="button">Done</button>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---------- iOS/iPad å°ˆç”¨è™•ç† ----------
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  
  // é˜²æ­¢ iOS Safari é›™æ“Šç¸®æ”¾ï¼ˆä½†ä¸å¹²æ“¾ textarea/output/modal çš„é¸å­—åŠŸèƒ½ï¼‰
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    // å¦‚æœæ˜¯åœ¨è¼¸å…¥å€ã€è¼¸å‡ºå€æˆ– modal å…§ï¼Œä¸é˜»æ“‹é›™æ“Šï¼ˆå…è¨±é¸å­—ï¼‰
    const target = e.target;
    if (target.closest('textarea, input, .out, .modal, pre, [contenteditable]')) {
      return;  // å…è¨±æ­£å¸¸çš„é›™æ“Šé¸å­—è¡Œç‚º
    }
    
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();  // åªåœ¨éæ–‡å­—å€åŸŸé˜»æ“‹é›™æ“Šç¸®æ”¾
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // é˜²æ­¢ iOS å½ˆæ€§æ»¾å‹•æº¢å‡º
  document.body.addEventListener('touchmove', (e) => {
    if (e.target.closest('textarea, .out, .modal')) return;
    if (document.body.scrollHeight <= window.innerHeight) {
      e.preventDefault();
    }
  }, { passive: false });
  
  // éµç›¤å½ˆå‡ºè™•ç†
  if (isIOS) {
    const textarea = $('q');
    textarea.addEventListener('focus', () => {
      document.body.classList.add('keyboard-open');
      // å»¶é²æ»¾å‹•åˆ°è¼¸å…¥æ¡†
      setTimeout(() => {
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    });
    textarea.addEventListener('blur', () => {
      document.body.classList.remove('keyboard-open');
    });
  }
  
  // è§¸è¦ºå›é¥‹ï¼ˆå¦‚æœæ”¯æ´ï¼‰
  function haptic(style = 'light') {
    if (navigator.vibrate) {
      const patterns = { light: 10, medium: 20, heavy: 30 };
      navigator.vibrate(patterns[style] || 10);
    }
  }

  // ---------- storage ----------
  const LS = {
    get(k, fallback=null){
      try{ const v = localStorage.getItem(k); return v===null? fallback : JSON.parse(v); }catch(e){ return fallback; }
    },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} },
    del(k){ try{ localStorage.removeItem(k); }catch(e){} }
  };
  const SS = {
    get(k, fallback=null){
      try{ const v = sessionStorage.getItem(k); return v===null? fallback : JSON.parse(v); }catch(e){ return fallback; }
    },
    set(k, v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  };

  // ---------- UI state ----------
  let activeTab = "safe";
  let aborter = null;
  let streaming = false;
  let accText = "";
  let blocks = { safe:"â€”", strong:"â€”", question:"â€”", notes:"â€”" };

  function setStatus(kind, text){
    $("dot").className = "dot " + (kind || "warn");
    $("status").textContent = text || "";
  }

  function getChips(){
    return Array.from(document.querySelectorAll(".chip.on")).map(el => el.dataset.chip);
  }

  function render(){
    $("out").textContent = blocks[activeTab] || "â€”";
    $("notes").textContent = blocks.notes || "â€”";
  }

  function templateDraft(q, chips){
    const c = chips;
    const wantsExample = c.some(x=>x.toLowerCase().includes("example"));
    const wantsTrade = c.some(x=>x.toLowerCase().includes("trade-off"));
    const wantsRisk = c.some(x=>x.toLowerCase().includes("risk"));

    const safe = `One way to look at this is to state the key assumption, then give one practical implication.`;
    const strong = `The key trade-off is what we gain now vs what we risk later; I'd prioritize based on the goal and time horizon.`;
    const question = `What metric are we optimizing for, and what time horizon are we assuming?`;

    const notes = [
      `Q: ${q.replace(/\s+/g,' ').trim()}`,
      wantsExample ? "Add 1 concrete example" : "Add 1 example (optional)",
      wantsTrade ? "Call out 1 trade-off" : "Trade-off (optional)",
      wantsRisk ? "1 risk + 1 mitigation" : "Risk/mitigation (optional)",
    ].map(x=>"â€¢ "+x).join("\n");

    return { safe, strong, question, notes };
  }

  function buildPrompt({mode, q, chips}){
    const chipText = chips.length ? `\nConstraints:\n${chips.map(x=>"- "+x).join("\n")}` : "";

    return `You are a fast classroom speaking coach. Help the student express THEIR OWN thinking ethically.
Return exactly 4 labeled blocks (no extra text):
SAFE: <1 sentence, <= 22 words>
STRONG: <1 sentence, <= 22 words>
QUESTION: <1 sentence, <= 22 words>
NOTES: <2-5 bullets>
Be natural for American classroom discussion. Do not invent facts.

Teacher question / keywords: ${q.trim()}${chipText}`;
  }

  function extractBlock(full, label){
    const re = new RegExp(label + ":[\\s\\S]*?(?=\\n[A-Z_]+:|$)", "i");
    const m = full.match(re);
    if (!m) return "";
    return m[0].replace(new RegExp("^"+label+":","i"),"").trim();
  }

  function applyPartial(full){
    const s = extractBlock(full, "SAFE");
    const st = extractBlock(full, "STRONG");
    const q = extractBlock(full, "QUESTION");
    const n = extractBlock(full, "NOTES");

    if (s) blocks.safe = s;
    else if (full.trim()) blocks.safe = full.replace(/\s+/g,' ').trim().slice(0, 220);

    if (st) blocks.strong = st;
    if (q) blocks.question = q;
    if (n) blocks.notes = n;

    render();
  }

  async function callOpenAIStreaming({endpoint, apiKey, model, maxTokens, temperature, prompt}){
    aborter = new AbortController();
    streaming = true;

    // ä½¿ç”¨ Chat Completions API æ ¼å¼
    // GPT-5 ç³»åˆ—éœ€è¦ç”¨ max_completion_tokensï¼ŒGPT-4 ç³»åˆ—ç”¨ max_tokens
    const isGPT5 = model.includes('gpt-5') || model.includes('o1') || model.includes('o3') || model.includes('o4');
    
    const body = {
      model,
      messages: [
        { role: "system", content: "You are a fast classroom speaking coach. Help the student express THEIR OWN thinking ethically. Be concise and natural." },
        { role: "user", content: prompt }
      ],
      stream: true,
      temperature
    };
    
    // æ ¹æ“šæ¨¡å‹é¸æ“‡æ­£ç¢ºçš„ token åƒæ•¸
    if (isGPT5) {
      body.max_completion_tokens = maxTokens;
    } else {
      body.max_tokens = maxTokens;
    }

    // ä½¿ç”¨ Chat Completions ç«¯é»
    const apiEndpoint = endpoint.includes('/responses') 
      ? endpoint.replace('/responses', '/chat/completions')
      : endpoint.endsWith('/chat/completions') 
        ? endpoint 
        : endpoint.replace(/\/?$/, '/chat/completions');

    const res = await fetch(apiEndpoint, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body: JSON.stringify(body),
      signal: aborter.signal
    });

    if (!res.ok){
      const msg = await res.text().catch(()=>"");
      throw new Error(`HTTP ${res.status}: ${msg.slice(0,200)}`);
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText = "";
    let sseBuffer = "";  // SSE ç·©è¡å€ï¼Œé˜²æ­¢ç¶²è·¯æŠ–å‹•é€ æˆæ¼å­—

    while(true){
      const {value, done} = await reader.read();
      if (done) break;
      
      // ç´¯ç©åˆ°ç·©è¡å€
      sseBuffer += decoder.decode(value, {stream:true});
      
      // ä»¥æ›è¡Œåˆ†å‰²ï¼Œä¿ç•™æœ€å¾Œä¸€æ®µï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰
      const lines = sseBuffer.split("\n");
      sseBuffer = lines.pop() || "";  // æœ€å¾Œä¸€è¡Œå¯èƒ½ä¸å®Œæ•´ï¼Œç•™åˆ°ä¸‹ä¸€è¼ª
      
      for (const line of lines){
        const trimmedLine = line.trim();
        if (trimmedLine.startsWith("data: ") && trimmedLine !== "data: [DONE]"){
          try {
            const json = JSON.parse(trimmedLine.substring(6));
            const delta = json.choices?.[0]?.delta?.content || "";
            if (delta) {
              fullText += delta;
              accText = fullText;
              applyPartial(fullText);
            }
          } catch(e) { /* skip invalid JSON, will retry with more data */ }
        }
      }
    }
    
    // è™•ç†ç·©è¡å€ä¸­å‰©é¤˜çš„å…§å®¹
    if (sseBuffer.trim()) {
      const trimmedLine = sseBuffer.trim();
      if (trimmedLine.startsWith("data: ") && trimmedLine !== "data: [DONE]") {
        try {
          const json = JSON.parse(trimmedLine.substring(6));
          const delta = json.choices?.[0]?.delta?.content || "";
          if (delta) {
            fullText += delta;
            accText = fullText;
            applyPartial(fullText);
          }
        } catch(e) { /* ignore final incomplete data */ }
      }
    }
    
    return fullText;
  }

  function stop(){
    if (aborter){
      try{ aborter.abort(); }catch(e){}
    }
    aborter = null;
    streaming = false;
  }

  function setBusy(b){
    $("quick").disabled = b;
    $("polish").disabled = b;
    $("stop").disabled = !b;
  }

  async function run(level){
    const q = $("q").value.trim();
    if (!q){ setStatus("bad","Type something âœï¸"); haptic('medium'); return; }

    haptic('light');
    
    // instant draft
    const chips = getChips();
    const draft = templateDraft(q, chips);
    blocks = { ...blocks, ...draft };
    render();
    setStatus("ok","Draft ready âœ“ (upgradingâ€¦) ");

    const provider = $("provider").value;
    if (provider === "template"){
      setStatus("ok","Template-only âœ“");
      haptic('medium');
      return;
    }

    const apiKey = $("key").value.trim();
    if (!apiKey){ setStatus("bad","Missing API key (open âš™ï¸)"); haptic('heavy'); return; }

    // persist key choice
    if ($("remember").checked) LS.set("LCL_key", apiKey);
    else { LS.del("LCL_key"); SS.set("LCL_key_session", apiKey); }

    const endpoint = $("endpoint").value.trim() || "https://api.openai.com/v1/chat/completions";
    const polishedModel = $("model").value;

    const model = (level === "quick") ? "gpt-4o-mini" : polishedModel;
    const maxTokens = (level === "quick") ? 100 : 180;
    const temperature = (level === "quick") ? 0.20 : 0.35;

    const prompt = buildPrompt({mode:"lightning", q, chips});

    setBusy(true);
    setStatus("warn", level === "quick" ? "Quick upgradingâ€¦" : "Polished upgradingâ€¦");

    try{
      accText = "";
      const full = await callOpenAIStreaming({endpoint, apiKey, model, maxTokens, temperature, prompt});

      const s = extractBlock(full, "SAFE");
      const st = extractBlock(full, "STRONG");
      const qu = extractBlock(full, "QUESTION");
      const n = extractBlock(full, "NOTES");
      if (s) blocks.safe = s;
      if (st) blocks.strong = st;
      if (qu) blocks.question = qu;
      if (n) blocks.notes = n;

      render();
      setStatus("ok", level === "quick" ? "Quick âœ“" : "Polished âœ“");
      haptic('medium');
    } catch(e){
      stop();
      setStatus("bad", (e && e.message) ? e.message.slice(0,80) : "Error");
      haptic('heavy');
    } finally {
      streaming = false;
      aborter = null;
      setBusy(false);
    }
  }

  // ---------- tabs ----------
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      haptic('light');
      document.querySelectorAll(".tab").forEach(b => {
        b.classList.remove("on");
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add("on");
      btn.setAttribute('aria-selected', 'true');
      activeTab = btn.dataset.tab;
      render();
    });
  });

  // chips
  $("chips").addEventListener("click", (e) => {
    const el = e.target.closest(".chip");
    if (!el) return;
    haptic('light');
    el.classList.toggle("on");
  });

  // buttons
  $("quick").addEventListener("click", () => run("quick"));
  $("polish").addEventListener("click", () => run("polished"));
  $("stop").addEventListener("click", () => { 
    stop(); 
    setBusy(false); 
    setStatus("warn","Stopped (draft kept) âœ“"); 
    haptic('medium');
  });

  // paste
  $("paste").addEventListener("click", async () => {
    haptic('light');
    try{
      const t = await navigator.clipboard.readText();
      if (t) $("q").value = ($("q").value + "\n" + t).trim();
      setStatus("ok","Pasted âœ“");
    } catch(e){ 
      setStatus("bad","Paste blocked"); 
      haptic('medium');
    }
  });

  // example
  $("example").addEventListener("click", () => {
    haptic('light');
    const arr = [
      "Should a company raise prices during inflation? risks? communication?",
      "Competitor cuts price 15% â€” what should we do? trade-offs?",
      "Efficiency vs resilience in supply chains â€” key trade-off?",
      "Enter a new market with limited data â€” how decide?"
    ];
    $("q").value = arr[Math.floor(Math.random()*arr.length)];
    setStatus("ok","Example loaded");
  });

  // copy current tab
  $("copy").addEventListener("click", async () => {
    const text = (blocks[activeTab] || "").trim();
    if (!text || text === "â€”") return;
    haptic('light');
    try{ 
      await navigator.clipboard.writeText(text); 
      setStatus("ok","Copied âœ“"); 
      haptic('medium');
    }
    catch(e){ 
      setStatus("bad","Copy failed"); 
      haptic('heavy');
    }
  });

  // speak current tab
  $("speak").addEventListener("click", () => {
    const text = (blocks[activeTab] || "").trim();
    if (!text || text === "â€”") return;
    haptic('light');
    try{
      if (!('speechSynthesis' in window)) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0;
      u.pitch = 1.0;
      // å„ªå…ˆä½¿ç”¨ iOS çš„é«˜å“è³ªèªéŸ³
      const voices = speechSynthesis.getVoices();
      const iosVoice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Daniel'));
      if (iosVoice) u.voice = iosVoice;
      speechSynthesis.speak(u);
      setStatus("ok","Speakingâ€¦");
    } catch(e){}
  });

  // keyboardï¼ˆåŠ å…¥ IME çµ„å­—ä¿è­·ï¼‰
  document.addEventListener("keydown", (e) => {
    // IME çµ„å­—ä¸­ï¼ˆæ³¨éŸ³/æ‹¼éŸ³ç­‰è¼¸å…¥æ³•ï¼‰ï¼Œä¸è§¸ç™¼å¿«æ·éµ
    if (e.isComposing || e.keyCode === 229) return;
    
    if (e.key === "Escape"){
      if (streaming){ 
        stop(); 
        setBusy(false); 
        setStatus("warn","Stopped (draft kept) âœ“"); 
        haptic('medium');
      }
      return;
    }
    if (e.key === "Enter" && !e.shiftKey){
      const active = document.activeElement;
      if (active && active.id === "q"){
        e.preventDefault();
        if (e.ctrlKey || e.metaKey) run("polished");
        else run("quick");
      }
    }
  });

  // settings modal
  function openModal(){
    haptic('light');
    $("overlay").style.display = "block";
    $("modal").style.display = "block";
    // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
    document.body.style.overflow = 'hidden';
  }
  function closeModal(){
    haptic('light');
    $("overlay").style.display = "none";
    $("modal").style.display = "none";
    document.body.style.overflow = '';
    persist();
  }

  $("gear").addEventListener("click", openModal);
  $("overlay").addEventListener("click", closeModal);
  $("close").addEventListener("click", closeModal);

  // persist settings
  function persist(){
    LS.set("LCL_settings", {
      provider: $("provider").value,
      model: $("model").value,
      endpoint: $("endpoint").value.trim() || "https://api.openai.com/v1/chat/completions",
      remember: $("remember").checked
    });
  }

  function restore(){
    const s = LS.get("LCL_settings", null);
    if (s){
      $("provider").value = s.provider || "openai";
      $("model").value = s.model || "gpt-4o";
      $("endpoint").value = s.endpoint || "https://api.openai.com/v1/chat/completions";
      $("remember").checked = !!s.remember;
    }
    const remembered = LS.get("LCL_key", "");
    const sessionKey = SS.get("LCL_key_session", "");
    if (remembered){ $("key").value = remembered; $("remember").checked = true; }
    else if (sessionKey){ $("key").value = sessionKey; }
  }

  // è¼‰å…¥èªéŸ³ï¼ˆiOS éœ€è¦å»¶é²è¼‰å…¥ï¼‰
  if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
  }

  restore();
  render();
  setStatus("ok","Ready");
})();
</script>
</body>
</html>
